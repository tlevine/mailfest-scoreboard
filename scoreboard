#!/usr/bin/env python3
from typing import Dict

import sys, os
import getpass
from time import sleep

from email import message_from_string

import feed
import stats

def read_email(email:str) -> dict:
    'Compute all the statistics.'
    parsed_email = message_from_string(email)
    stat_names = filter(lambda x: not x.startswith('_'), dir(stats))
    return {stat: getattr(stats, stat)(parsed_email) for stat in stat_names}

def credentials() -> Dict[str,str]:
    'Get the email account credentials.'
    c = {
        'host': os.environ.get('MAILFEST_IMAP_HOST', 'mail.gandi.net'),
        'address': os.environ.get('MAILFEST_ADDRESS', 'mailfest@thomaslevine.com'),
        'password': os.environ.get('MAILFEST_PASSWORD'),
    }
    if not c['password']:
         c['password'] = getpass.getpass('Password for %s:' % c['address'])
    return c

def main():
    M = feed.Mailbox(**credentials())
    while True:
        num, email = M.peek()
        if num == None:
            sleep(10)
        else:
            email_stats = read_email(email)
            # M.delete(num)

if __name__== '__main__':
    main()
